<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Book Recommender</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel to process the JSX directly in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Optional: Set a clean font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root">
        <!-- React application will be mounted here -->
    </div>

    <!-- Firebase CDN Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, limit, onSnapshot, serverTimestamp, orderBy, addDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These variables are required by the embedded React code.
        window.__app_id = "recommender-app-public-id";

        // ðŸš¨ ACTION REQUIRED (1/2): Replace {} with your Firebase configuration object
        // Example: {apiKey: "AIza...", authDomain: "...", projectId: "..."}
        window.__firebase_config = JSON.stringify({
  apiKey: "AIzaSyCn-GsUfr-GoJOiC9IGAljJyp_SO2kDZyw",
  authDomain: "book-recommender-system-65a31.firebaseapp.com",
  projectId: "book-recommender-system-65a31",
  storageBucket: "book-recommender-system-65a31.firebasestorage.app",
  messagingSenderId: "434102354126",
  appId: "1:434102354126:web:37bb5473e91ae4b364909f",
  measurementId: "G-EVWR577LB5"
}); 

        window.__initial_auth_token = null; // We will default to anonymous sign-in

        // Make Firebase functions available globally
        window.firebase = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, collection, query, limit, onSnapshot, serverTimestamp, orderBy, addDoc, doc
        };
        
        // Expose React hooks for the JSX script to use
        window.React = React;
        window.useState = React.useState;
        window.useEffect = React.useEffect;
        window.useCallback = React.useCallback;
        window.useMemo = React.useMemo;
        window.useRef = React.useRef;

    </script>

    <!-- Main Application Code (JSX) -->
    <script type="text/babel" id="app-script">
        
        // --- Configuration and Constants ---

        // Global variables provided by the environment (MANDATORY USE)
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {};
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;
        
        // ðŸš¨ ACTION REQUIRED (2/2): Insert your Gemini API Key here.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=AIzaSyCKbEfIZ2ILstZFi-H-M3lMp68o603KQyo`;
        
        // STRENGTHENED SYSTEM INSTRUCTION (Focus on ID and title retrieval only)
        const GEMINI_SYSTEM_INSTRUCTION = `You are an expert book recommender. Your task is to select the top 3 most semantically similar books from the provided list based on the user's query and filters. 
        Your response MUST be ONLY the requested JSON array of up to 3 book objects, containing ONLY the 'id', 'title', and 'description' keys. DO NOT INCLUDE ANY MARKDOWN FENCE (e.g., \`\`\`json), EXPLANATION, GREETING, OR OTHER TEXT.`;

        const SAMPLE_BOOKS = [
        { id: 1, title: "The Obsidian Star", author: "A. J. Thorne", description: "A dark fantasy where a reluctant hero must master forbidden magic to stop a corrupt empire. Themes of loss and revenge.", category: "Fantasy", tone: "Suspenseful" },
        { id: 2, title: "Silicon Valley Zen", author: "L. K. Patel", description: "A non-fiction guide to integrating mindfulness and productivity in the high-stress tech world. Focuses on mental well-being.", category: "Non-Fiction", tone: "Calm" },
        { id: 3, title: "The Clockwork Detective", author: "V. R. Steam", description: "A thrilling Victorian mystery set in a steampunk London where a detective hunts a cunning saboteur.", category: "Thriller", tone: "Surprising" },
        { id: 4, title: "Coral Reef Guardians", author: "Dr. E. Marine", description: "A beautiful, non-fiction photographic journey exploring ocean conservation and marine biology. Educational and inspiring.", category: "Non-Fiction", tone: "Happy" },
        { id: 5, title: "Echoes of the Void", author: "J. S. Wells", description: "A deep space opera where two rival starships form an uneasy alliance against an unknown existential threat. Full of action and political intrigue.", category: "Sci-Fi", tone: "Suspenseful" },
        { id: 6, title: "A Chef's Memoir", author: "M. E. Cuisin", description: "The true story of a young chef's rise from street food stall to Michelin-star restaurant. A story of passion and persistence.", category: "Non-Fiction", "tone": "Happy" },
        { id: 7, title: "The Last Scroll", author: "T. R. Griffin", description: "A historical thriller about a secret society racing to find an ancient manuscript that could rewrite history.", category: "Thriller", tone: "Surprising" },
        { id: 8, title: "The Sixth Seal", author: "T. R. Griffin", description: "A globetrotting mystery involving ancient artifacts, religious conspiracies, and a detective racing against time to stop a cult.", category: "Mystery", tone: "Suspenseful" },
        { id: 9, title: "Ocean's Fury", author: "Dr. E. Marine", description: "A stunning non-fiction photographic collection and essay on the world's most dangerous marine creatures and the fragile deep-sea ecosystem.", category: "Non-Fiction", tone: "Serious" },
        { id: 10, title: "Starfall Colony", author: "M. K. Jones", description: "A space opera where a newly colonized planet must survive a war against an alien species and internal political sabotage. Full of action and political intrigue.", category: "Sci-Fi", tone: "Surprising" },
        { id: 11, title: "The Baker's Apprentice", author: "C. M. Roux", description: "A heartwarming romance set in a small French town where a baker and a travel writer find unexpected love amid the aroma of fresh bread.", category: "Romance", tone: "Happy" },
        { id: 12, title: "Chronicles of Aethelred", author: "P. R. King", description: "A high-fantasy epic about a chosen hero reclaiming his throne from a tyrannical sorcerer. Classic themes of good versus evil and destiny.", category: "Fantasy", tone: "Adventure" },
        { id: 13, title: "The Silent Witness", author: "B. L. Trent", description: "A tense legal thriller about a defense attorney defending a client who refuses to speak about the crime. Twists and turns guaranteed.", category: "Thriller", tone: "Suspenseful" },
        { id: 14, title: "Digital Detox 30-Day Plan", author: "L. K. Patel", description: "A practical non-fiction handbook offering a step-by-step guide to disconnecting from technology and improving real-world relationships.", category: "Non-Fiction", tone: "Calm" },
        { id: 15, title: "Gladiators of Rome", author: "H. V. Mars", description: "A detailed historical account of the lives, training, and political significance of gladiators in the Roman Empire. Highly informative.", category: "Historical Fiction", tone: "Serious" },
        { id: 16, title: "The Cosmic Traveler", author: "J. S. Wells", description: "An exhilarating Sci-Fi adventure following a lone pilot who discovers a new form of interstellar travel, leading to unexpected danger.", category: "Sci-Fi", tone: "Adventure" },
        { id: 17, title: "Murder at Midnight", author: "A. W. Christie", description: "A classic whodunit set in a secluded English manor house during a snowstorm. A brilliant detective must uncover the culprit.", category: "Mystery", tone: "Surprising" },
        { id: 18, title: "The Way of the Zen Programmer", author: "K. R. Data", description: "Non-fiction guide for software developers on maintaining focus, preventing burnout, and integrating meditative practices into coding.", category: "Non-Fiction", tone: "Calm" },
        { id: 19, title: "Heartbreak on the Riviera", author: "G. V. Belle", description: "A passionate modern romance about a struggling artist who falls for a mysterious billionaire during a summer trip to the South of France.", category: "Romance", tone: "Happy" },
        { id: 20, title: "The Obsidian Mirror", author: "A. J. Thorne", description: "The sequel to The Obsidian Star. The reluctant hero faces a darker magic and a personal betrayal that threatens to shatter the resistance.", category: "Fantasy", tone: "Suspenseful" },
        { id: 21, title: "Neon City Dreams", author: "L. K. Neo", description: "A cyberpunk thriller set in a futuristic mega-city where a hacker is framed for a high-profile corporate crime and must clear their name.", category: "Thriller", tone: "Adventure" },
        { id: 22, title: "Mind over Money", author: "P. S. Wealth", description: "A personal finance non-fiction guide focusing on the psychological barriers to saving and investing. Practical tips for financial freedom.", category: "Non-Fiction", tone: "Inspirational" },
        { id: 23, title: "Curse of the Pharaoh", author: "M. E. Cais", description: "An archaeological adventure-thriller where a team unearths a cursed tomb and must escape both traps and a vengeful spirit.", category: "Thriller", tone: "Suspenseful" },
        { id: 24, title: "The Hidden Life of Bees", author: "Dr. B. Buzzer", description: "A fascinating non-fiction look at the complex social structure and ecological importance of various bee species. Educational and inspiring.", category: "Non-Fiction", tone: "Happy" },
        { id: 25, title: "The Moon Gate Protocol", author: "H. G. Planet", description: "A gripping first-contact Sci-Fi novel where humanity finds an alien artifact that could be a weapon or a salvation. High stakes and political tension.", category: "Sci-Fi", tone: "Serious" },
        { id: 26, title: "Kitchen Confessions", author: "M. E. Cuisin", description: "The follow-up memoir to A Chef's Memoir, revealing the dramatic backstage politics and high-pressure world of Michelin-star competition.", category: "Non-Fiction", tone: "Witty" },
        { id: 27, title: "The Serpent's Tooth", author: "V. R. Steam", description: "A Victorian Mystery where The Clockwork Detective hunts a political assassin using newly developed steam-powered technology.", category: "Mystery", tone: "Surprising" },
        { id: 28, title: "Shadows of the Dynasty", author: "C. N. Lee", description: "A sweeping historical fiction saga about three generations of a powerful family struggling to maintain control during a period of civil war.", category: "Historical Fiction", tone: "Melancholy" },
        { id: 29, title: "Love in the Time of AI", author: "D. S. Heart", description: "A near-future romance exploring what happens when a human falls in love with an advanced, personalized AI companion. Tender and thought-provoking.", category: "Romance", tone: "Witty" },
        { id: 30, title: "The Dragon's Breath", author: "T. R. Griffin", description: "The ancient manuscript is found, but the secret society must now protect it from global powers who wish to misuse its world-changing knowledge.", category: "Thriller", tone: "Adventure" },
    { id: 31, title: "A Court of Thorns and Glory", author: "R. M. Fey", description: "A high-stakes fantasy romance about a mortal girl swept into the treacherous world of the Fae, where political schemes are as deadly as magic.", category: "Fantasy", tone: "Suspenseful" },
    { id: 32, title: "The Power of Habit Stacking", author: "J. A. Clearer", description: "A non-fiction guide focused on behavioral psychology and creating micro-habits for massive long-term self-improvement. Highly practical.", category: "Non-Fiction", tone: "Inspirational" },
    { id: 33, title: "Terminal Velocity", author: "S. K. Pace", description: "A military Sci-Fi novel about an elite squad sent on a seemingly impossible mission to neutralize a hostile alien warship. Pure action.", category: "Sci-Fi", tone: "Adventure" },
    { id: 34, title: "The Venetian Glassmaker", author: "L. M. Craft", description: "A dual-timeline historical mystery about a modern researcher who discovers a deadly secret hidden in the craftsmanship of 17th-century Murano glass.", category: "Mystery", tone: "Melancholy" },
    { id: 35, title: "Under the Blood Moon", author: "C. D. Hunter", description: "A paranormal romance about a forbidden love between a werewolf hunter and the pack alpha she is sworn to destroy. Intense and emotional.", category: "Romance", tone: "Suspenseful" },
    { id: 36, title: "Ecology of the Tundra", author: "Dr. A. Freeze", description: "An in-depth non-fiction study on the resilience and fragility of polar ecosystems in the face of climate change. Detailed and educational.", category: "Non-Fiction", tone: "Serious" },
    { id: 37, title: "The Emperor's Blade", author: "A. J. Thorne", description: "A fantasy military epic focusing on a soldier's journey through war, honor, and the moral compromises required to serve a morally ambiguous empire.", category: "Fantasy", tone: "Serious" },
    { id: 38, title: "The Silicon Alchemist", author: "B. T. Gold", description: "A corporate thriller about a breakthrough in sustainable energy technology and the desperate measures powerful oil corporations take to suppress it.", category: "Thriller", tone: "Surprising" },
    { id: 39, title: "Coding for Kids: Python", author: "E. Z. Code", description: "A fun and simple non-fiction introduction to programming using Python, featuring games and easy-to-follow projects. Great for beginners.", category: "Non-Fiction", tone: "Happy" },
    { id: 40, title: "Wormhole Drift", author: "J. S. Wells", description: "The rival starships from Echoes of the Void must now navigate a damaged spacetime fabric, threatening to trap them forever in an uncharted dimension.", category: "Sci-Fi", tone: "Suspenseful" },
    { id: 41, title: "The Case of the Missing Jewels", author: "P. I. Snoop", description: "A lighthearted cozy mystery where a retired librarian solves a series of petty crimes in her quiet coastal town. Witty and charming.", category: "Mystery", tone: "Witty" },
    { id: 42, title: "The Romanov Conspiracy", author: "T. R. Griffin", description: "A historical thriller where the protagonist discovers evidence that the Romanovs may have survived, triggering a hunt across Europe.", category: "Thriller", tone: "Adventure" },
    { id: 43, title: "Seven Days in Tuscany", author: "E. L. Bloom", description: "A charming, feel-good romance about a woman who inherits a villa in Italy and finds love while restoring the property and discovering family secrets.", category: "Romance", tone: "Happy" },
    { id: 44, title: "The Gilded Cage", author: "L. M. Craft", description: "A historical fiction novel set in 1920s New York, following an immigrant dancer who tries to break into the world of Broadway and high society.", category: "Historical Fiction", tone: "Inspirational" },
    { id: 45, title: "The Sunken City", author: "Dr. E. Marine", description: "A thrilling non-fiction deep-sea diving narrative detailing the discovery of a massive, ancient underwater civilization off the coast of Japan.", category: "Non-Fiction", tone: "Surprising" },
    { id: 46, title: "Echoes of the Elven Queen", author: "R. A. Sterling", description: "A high-fantasy epic about an exiled queen who must gather a coalition of disparate races to save her kingdom from an invading shadow army.", category: "Fantasy", tone: "Adventure" },
    { id: 47, title: "The Zero-Sum Game", author: "C. N. Lee", description: "A political thriller about a newly elected President who uncovers a secret cabal that controls global finance and warfare. High stakes, modern setting.", category: "Thriller", tone: "Serious" },
    { id: 48, title: "Astronomy for the City Dweller", author: "K. R. Data", description: "A practical non-fiction guide to identifying constellations and planets even in light-polluted urban areas. Simple and informative.", category: "Non-Fiction", tone: "Happy" },
    { id: 49, title: "The Star Eater", author: "H. G. Planet", description: "A cosmic horror Sci-Fi novel about a research vessel that encounters a creature capable of consuming entire stars. Terrifying and mind-bending.", category: "Sci-Fi", tone: "Suspenseful" },
    { id: 50, title: "The Chemist's Secret", author: "B. L. Trent", description: "A locked-room mystery set in a high-tech chemistry lab where a world-renowned scientist is murdered, and everyone is a suspect.", category: "Mystery", tone: "Surprising" },
    { id: 51, title: "The Rogue Protocol", author: "A. J. Thorne", description: "A technothriller about an advanced military AI that goes rogue and the programmer who must find a way to shut it down before it launches a global strike.", category: "Thriller", tone: "Adventure" },
    { id: 52, title: "Gardening for a New Planet", author: "Dr. B. Buzzer", description: "A non-fiction guide focused on regenerative agriculture and climate-friendly gardening techniques for home enthusiasts and small farms.", category: "Non-Fiction", tone: "Calm" },
    { id: 53, title: "The Siren's Call", author: "D. S. Heart", description: "A contemporary romance about a marine biologist who falls for a mysterious man claiming to be a descendant of mythological sirens. Emotional and dramatic.", category: "Romance", tone: "Melancholy" },
    { id: 54, title: "Vikings of the North Sea", author: "H. V. Mars", description: "A historical fiction saga detailing the brutal yet complex social and political life of a Viking raiding party and their clash with Saxon England.", category: "Historical Fiction", tone: "Serious" },
    { id: 55, title: "The Last City of Xylos", author: "V. A. Smith", description: "A post-apocalyptic Sci-Fi adventure where a scavenger discovers a map leading to the rumored last bastion of pre-collapse technology.", category: "Sci-Fi", tone: "Adventure" },
    { id: 56, title: "The Clockwork Rebel", author: "V. R. Steam", description: "The Clockwork Detective is now a wanted man, forced to team up with the saboteur he once hunted to expose corruption at the highest level of London society.", category: "Mystery", tone: "Witty" },
    { id: 57, title: "The Atlas of Lost Worlds", author: "J. D. Moran", description: "A beautiful non-fiction book featuring stunning maps and essays on historical places and civilizations that have vanished from the modern world.", category: "Non-Fiction", tone: "Serious" },
    { id: 58, title: "A Song for the Fallen", author: "E. F. Holloway", description: "A dark fantasy where a necromancer attempts to resurrect a dead kingdom, only to find the cost is his own soul and the allegiance of his allies.", category: "Fantasy", tone: "Melancholy" },
    { id: 59, title: "Hollywood Hustle", author: "P. R. King", description: "A witty, fast-paced romance about a struggling screenwriter and a famous but jaded movie star who are forced to collaborate on a new film.", category: "Romance", tone: "Witty" },
    { id: 60, title: "The Stolen Code", author: "L. K. Patel", description: "A fast-paced techno-thriller about an ethical hacker trying to prevent the release of a devastating piece of ransomware created by a former colleague.", category: "Thriller", tone: "Suspenseful" },
    { id: 61, title: "Zen and the Art of Data Science", author: "K. R. Data", description: "Non-fiction guide for data professionals on using meditative focus and clear methodology to tackle complex datasets and machine learning challenges.", category: "Non-Fiction", tone: "Calm" },
    { id: 62, title: "The Ring of Destiny", author: "R. M. Fey", description: "The Fae world is on the brink of civil war, and the mortal heroine must choose between her human life and the crown she never asked for.", category: "Fantasy", tone: "Suspenseful" },
    { id: 63, title: "Dust and Starlight", author: "M. K. Jones", description: "A post-apocalyptic Sci-Fi romance set on a desolate Earth where the last two survivors of a catastrophe find hope and love in their shared isolation.", category: "Sci-Fi", tone: "Melancholy" },
    { id: 64, title: "The Lighthouse Killer", author: "J. D. Moran", description: "The sequel to The Last Lighthouse Keeper, as a private investigator is called in to solve a string of disappearances linked to the same remote coastal area.", category: "Mystery", tone: "Surprising" },
    { id: 65, title: "The Secret History of Tea", author: "C. M. Roux", description: "A charming historical fiction novel following a family of tea merchants from 18th-century China to the courts of Victorian England.", category: "Historical Fiction", tone: "Happy" },
    { id: 66, title: "The Seven Summits of Success", author: "P. S. Wealth", description: "A non-fiction motivational book using mountain climbing as a metaphor for overcoming professional and personal challenges. Highly inspiring.", category: "Non-Fiction", tone: "Inspirational" },
    { id: 67, title: "A Kiss in the Rain", author: "E. L. Bloom", description: "A classic sweet romance about two childhood friends who reconnect at a rainy wedding and realize their platonic bond has deepened into true love.", category: "Romance", tone: "Happy" },
    { id: 68, title: "Planet of the Spores", author: "H. G. Planet", description: "A biological Sci-Fi horror where a research team on an alien world realizes the entire planet is a single, hostile, fungal organism.", category: "Sci-Fi", tone: "Serious" },
    { id: 69, title: "The Art Forgery", author: "B. L. Trent", description: "An art world thriller about a talented but broke artist recruited by a criminal syndicate to forge a priceless Renaissance masterpiece. Morally ambiguous.", category: "Thriller", tone: "Witty" },
    { id: 70, title: "The Monk and the Algorithm", author: "S. P. Chopra", description: "A non-fiction blend of philosophy and technology, exploring how ancient spiritual teachings can inform the ethical design and use of modern AI.", category: "Non-Fiction", tone: "Serious" },
    { id: 71, title: "The Golden Compass Quest", author: "P. R. King", description: "A family-friendly fantasy adventure about a young girl who discovers a magical compass and must follow it to save her kidnapped parents.", category: "Fantasy", tone: "Adventure" },
    { id: 72, "title": "The Whitechapel Reaper", "author": "V. R. Steam", "description": "A dark Victorian mystery where the Clockwork Detective pursues a Jack the Ripper-like figure who is targeting victims with unusual metallic components.", "category": "Mystery", "tone": "Suspenseful" },
    { id: 73, "title": "The Last Battle of Camelot", "author": "R. A. Sterling", "description": "A historical fantasy novel that retells the final days of King Arthur and the moral failings that led to the collapse of his legendary kingdom.", "category": "Historical Fiction", "tone": "Melancholy" },
    { id: 74, "title": "The CEO's Proposal", "author": "G. V. Belle", "description": "A steamy contemporary romance where a high-powered CEO offers his assistant a fake engagement to secure a business deal, leading to real feelings.", "category": "Romance", "tone": "Surprising" },
    { id: 75, "title": "Digital Diplomacy", "author": "C. N. Lee", "description": "A non-fiction analysis of how social media, cyber warfare, and online influence campaigns are reshaping international relations and global politics.", "category": "Non-Fiction", "tone": "Serious" },
    { id: 76, "title": "The Ghost in the Machine", "author": "L. K. Neo", "description": "A Sci-Fi thriller about a team trying to evacuate a space station before a sentient program takes control of all life support systems and traps them.", "category": "Sci-Fi", "tone": "Suspenseful" },
    { id: 77, "title": "The Codebreaker's Daughter", "author": "T. R. Griffin", "description": "A World War II historical thriller about a young woman who discovers her late father was a famous codebreaker and must complete his last, most dangerous mission.", "category": "Thriller", "tone": "Adventure" },
    { id: 78, "title": "The Joy of Being Present", "author": "L. K. Patel", "description": "A non-fiction guide to mastering deep focus, overcoming distraction, and living fully in the moment, regardless of life's demands. Calm and helpful.", "category": "Non-Fiction", "tone": "Calm" },
    { id: 79, "title": "The Golden Age of Pirates", "author": "H. V. Mars", "description": "A historical fiction adventure about a charismatic but ruthless pirate captain who sails the Caribbean, battling naval forces and rival buccaneers.", "category": "Adventure", "tone": "Adventure" },
    { id: 80, "title": "A Witch's Vow", "author": "E. F. Holloway", "description": "A fantasy romance where a powerful witch must break a centuries-old curse, but the only way involves sacrificing her true love. Dark and emotional.", "category": "Fantasy", "tone": "Suspenseful" },
    { id: 81, "title": "The Last Train to Nowhere", "author": "J. D. Moran", "description": "A classic train mystery where a passenger is murdered on a non-stop journey, and the list of suspects includes all the elite travelers on board.", "category": "Mystery", "tone": "Witty" },
    { id: 82, "title": "The Power of Introverts in Leadership", "author": "P. S. Wealth", "description": "A non-fiction business book arguing that quiet reflection and deep focus are the keys to effective modern leadership. Empowering and insightful.", "category": "Non-Fiction", "tone": "Inspirational" },
    { id: 83, "title": "The Martian Genesis", "author": "Dr. L. K. Vance", "description": "A Sci-Fi novel about the first human colony on Mars and the discovery of evidence of an ancient, pre-human civilization beneath the red dust.", "category": "Sci-Fi", "tone": "Serious" },
    { id: 84, "title": "Chocolate & Confessions", "author": "C. M. Roux", "description": "A lighthearted romance set in a struggling chocolate shop where the owner and a food critic find themselves falling in love amidst business rivalry.", "category": "Romance", "tone": "Happy" },
    { id: 85, "title": "Saving the Great Barrier Reef", "author": "Dr. E. Marine", "description": "An urgent non-fiction plea and scientific overview of the threats facing the Great Barrier Reef and the global efforts to save this natural wonder.", "category": "Non-Fiction", "tone": "Serious" },
    { id: 86, "title": "Empire of Dust", "author": "A. J. Thorne", "description": "The third and final book in the dark fantasy trilogy. The reluctant hero leads a massive rebellion against the corrupt empire in a final, climactic battle.", "category": "Fantasy", "tone": "Adventure" },
    { id: 87, "title": "The Diplomat's Wife", "author": "L. M. Craft", "description": "A post-WWII historical thriller where a diplomat's wife in Berlin is recruited by Allied intelligence to spy on a former Nazi hiding in plain sight.", "category": "Historical Fiction", "tone": "Suspenseful" },
    { id: 88, "title": "The Last Laugh", "author": "S. K. Pace", "description": "A high-octane action thriller about an ex-special forces operative who must protect a whistleblower from a powerful mercenary organization.", "category": "Thriller", "tone": "Adventure" },
    { id: 89, "title": "Unlocking Your Creative Self", "author": "E. Z. Code", "description": "A non-fiction guide offering exercises and mindsets to overcome creative blocks and unlock your full potential in art, writing, or business.", "category": "Non-Fiction", "tone": "Inspirational" },
    { id: 90, "title": "The Alien Artifact", "author": "J. S. Wells", "description": "The final book in the space opera series. The two rival starships must sacrifice everything to destroy the existential threat using a mysterious alien relic.", "category": "Sci-Fi", "tone": "Surprising" },
    ];

        const CATEGORY_OPTIONS = ['All', 'Fantasy', 'Non-Fiction', 'Thriller', 'Sci-Fi'];
        const TONE_OPTIONS = ['All', 'Suspenseful', 'Calm', 'Surprising', 'Happy'];

        // Helper function for delay
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));


        // --- Firebase & Auth Setup Hook ---

        const useFirebase = () => {
        // Access Firebase functions from the global window object
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebase;
        const useState = window.useState;
        const useEffect = window.useEffect;

        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);
        const [isAuthReady, setIsAuthReady] = useState(false);

        useEffect(() => {
            try {
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config is empty. History saving is disabled.");
                setUserId('disabled-local-user'); // Allow app to render, but queries will fail
                setIsAuthReady(true);
                return;
            }

            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const authInstance = getAuth(app);
            setDb(firestore);
            setAuth(authInstance);

            // Sign in anonymously if no token, otherwise use custom token
            const authenticate = async () => {
                try {
                if (initialAuthToken) {
                    await signInWithCustomToken(authInstance, initialAuthToken);
                } else {
                    await signInAnonymously(authInstance);
                }
                } catch (error) {
                console.error("Firebase Auth Error:", error);
                }
            };

            const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                // Ensure userId is only set to the official UID or null (loading)
                setUserId(user ? user.uid : null);
                setIsAuthReady(true);
            });

            authenticate();
            return () => unsubscribe();
            } catch (e) {
            console.error("Failed to initialize Firebase:", e);
            }
        }, []);

        return { db, auth, userId, isAuthReady };
        };

        // --- History Hook ---
        const useHistory = (db, userId, isAuthReady) => {
        const { collection, query, limit, onSnapshot, serverTimestamp, orderBy, addDoc } = window.firebase;
        const useState = window.useState;
        const useEffect = window.useEffect;
        const useCallback = window.useCallback;

        const [history, setHistory] = useState([]);

        useEffect(() => {
            if (!db || !userId || !isAuthReady) return;

            // Private collection path for user history
            const historyPath = `/artifacts/${appId}/users/${userId}/recommendation_queries`;
            
            const q = query(collection(db, historyPath), orderBy("timestamp", "desc"), limit(5));

            const unsubscribe = onSnapshot(q, (snapshot) => {
            const historyList = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setHistory(historyList);
            }, (error) => {
            console.error("Error listening to history:", error);
            });

            return () => unsubscribe();
        }, [db, userId, isAuthReady]);

        const saveQuery = useCallback(async (queryText, category, tone) => {
            if (!db || !userId) {
            // console.error("Database not ready or user not authenticated.");
            return;
            }
            try {
            const historyPath = `/artifacts/${appId}/users/${userId}/recommendation_queries`;
            await addDoc(collection(db, historyPath), {
                query: queryText,
                category: category,
                tone: tone,
                timestamp: serverTimestamp(),
            });
            } catch (e) {
            console.error("Error adding document: ", e);
            }
        }, [db, userId]);

        return { history, saveQuery };
        };

        // --- Main Application Component ---
        const App = () => {
        const { useMemo } = window.React;
        const { useState, useEffect, useCallback } = window;
        const { db, userId, isAuthReady } = useFirebase();
        const { history, saveQuery } = useHistory(db, userId, isAuthReady);

        const [queryText, setQueryText] = useState('');
        const [categoryFilter, setCategoryFilter] = useState('All');
        const [toneFilter, setToneFilter] = useState('All');
        const [recommendations, setRecommendations] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const [errorMessage, setErrorMessage] = useState('');

        // Function to handle the API call and retry logic (exponential backoff)
        const fetchRecommendations = useCallback(async (payload, maxRetries = 3) => {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                        if (attempt < maxRetries - 1) {
                            await delay(Math.pow(2, attempt) * 1000); // Exponential backoff
                            continue; // Retry
                        }
                        throw new Error("LLM failed to return a valid response after retries.");
                    }

                    // 1. Parse the JSON from the LLM
                    let parsedJson;
                    try {
                        // Attempt to clean up common malformed JSON issues (e.g., surrounding text or markdown block fences)
                        // This cleanup step is CRITICAL for handling bad LLM output
                        const cleanedJsonText = jsonText.replace(/^```json\s*/, '').replace(/\s*```$/, '').trim();
                        parsedJson = JSON.parse(cleanedJsonText);
                    } catch (e) {
                        if (attempt < maxRetries - 1) {
                            console.warn(`JSON parsing failed (Attempt ${attempt + 1}). Retrying...`);
                            await delay(Math.pow(2, attempt) * 1000); // Exponential backoff
                            continue; // Retry
                        }
                        throw new Error("LLM returned malformed JSON after retries. Final JSON check failed.");
                    }

                    // 2. Extract IDs and map to full book objects
                    // Ensure parsedJson is an array before mapping
                    const arrayResult = Array.isArray(parsedJson) ? parsedJson : [];
                    const recommendedIds = arrayResult.map(book => book.id).filter(id => id !== undefined);
                    const finalRecommendations = SAMPLE_BOOKS.filter(book => recommendedIds.includes(book.id));
                    
                    return finalRecommendations;

                } catch (error) {
                    if (attempt < maxRetries - 1) {
                        console.warn(`API call failed (Attempt ${attempt + 1}). Retrying...`);
                        await delay(Math.pow(2, attempt) * 1000); // Exponential backoff
                        continue;
                    }
                    throw error;
                }
            }
            return [];
        }, []);


        // Function to perform the LLM-based semantic search
        const recommendBooks = async (e) => {
            e.preventDefault();
            if (!queryText.trim()) {
            setErrorMessage("Please enter a description for your book.");
            return;
            }
            setErrorMessage('');
            setRecommendations([]);
            setIsLoading(true);

            // 1. Client-side filter applied before sending to LLM
            const filteredBooks = SAMPLE_BOOKS.filter(book =>
            (categoryFilter === 'All' || book.category === categoryFilter) &&
            (toneFilter === 'All' || book.tone === toneFilter)
            );

            if (filteredBooks.length === 0) {
            setRecommendations([]);
            setErrorMessage("No books match the current filters. Please adjust them.");
            setIsLoading(false);
            return;
            }

            // Prepare the simplified list of available books for the prompt
            // Only send ID, title, and description to reduce clutter and confusion for the LLM
            const bookListForLLM = filteredBooks.map(book => ({
                id: book.id,
                title: book.title,
                description: book.description,
                category: book.category, // Include category/tone for better LLM matching
                tone: book.tone
            }));

            const userPrompt = `
            User Query: ${queryText}
            
            Based on the query, select the best matches from this list of books:
            ${JSON.stringify(bookListForLLM)}
            `;

            const payload = {
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: { parts: [{ text: GEMINI_SYSTEM_INSTRUCTION }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                    id: { type: "INTEGER" },
                    title: { type: "STRING" },
                    description: { type: "STRING" },
                    },
                    propertyOrdering: ["id", "title", "description"],
                }
            }
            }
            };

            try {
                // Use the retry function to fetch recommendations
                const finalRecommendations = await fetchRecommendations(payload);
                
                if (finalRecommendations.length === 0 && filteredBooks.length > 0) {
                     setErrorMessage("The model couldn't find relevant books from the available list.");
                } else {
                     setRecommendations(finalRecommendations);
                }

                // Save to history (non-blocking)
                saveQuery(queryText, categoryFilter, toneFilter);

            } catch (error) {
                console.error("Recommendation Process Error:", error);
                // Display the user-friendly error message from the retry logic
                setErrorMessage(`Recommendation failed: ${error.message}`);
            } finally {
                setIsLoading(false);
            }
        };

        const MemoizedHistory = useMemo(() => (
            <div className="bg-white/5 p-4 rounded-xl h-full overflow-y-auto">
            <h3 className="text-lg font-semibold text-indigo-300 mb-3 border-b border-indigo-500/30 pb-1">
                Your Recent Searches
            </h3>
            {!isAuthReady ? (
                <p className="text-sm text-gray-400 animate-pulse">Initializing user session...</p>
            ) : history.length === 0 ? (
                <p className="text-sm text-gray-400">Search history will appear here.</p>
            ) : (
                <div className="space-y-3">
                {history.map((item, index) => (
                    <div
                    key={item.id}
                    className="p-3 bg-white/10 rounded-lg hover:bg-white/20 transition cursor-pointer"
                    onClick={() => {
                        setQueryText(item.query);
                        setCategoryFilter(item.category);
                        setToneFilter(item.tone);
                        setErrorMessage('');
                        setRecommendations([]);
                    }}
                    >
                    <p className="text-sm font-medium text-white line-clamp-2">
                        "{item.query}"
                    </p>
                    <div className="flex text-xs space-x-2 mt-1">
                        <span className="bg-indigo-600/50 px-2 py-0.5 rounded-full text-indigo-200">
                        {item.category}
                        </span>
                        <span className="bg-pink-600/50 px-2 py-0.5 rounded-full text-pink-200">
                        {item.tone}
                        </span>
                    </div>
                    </div>
                ))}
                </div>
            )}
            {userId && <p className="mt-4 text-xs text-gray-500 truncate">User ID: {userId}</p>}
            </div>
        ), [history, isAuthReady, userId, setQueryText, setCategoryFilter, setToneFilter]);


        return (
            <div className="min-h-screen bg-gray-900 text-white p-4 sm:p-8 font-sans">
            <div className="max-w-6xl mx-auto">
                <header className="mb-8 border-b border-indigo-700 pb-4">
                <h1 className="text-3xl sm:text-4xl font-extrabold text-indigo-400">
                    Semantic Book Recommender
                </h1>
                <p className="text-indigo-200/80 mt-1">
                    Find your next read using LLM-powered semantic search.
                </p>
                </header>

                <main className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* LEFT COLUMN: Input Form and Filters */}
                <div className="lg:col-span-2 space-y-8">
                    <div className="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-700">
                    <h2 className="text-2xl font-bold mb-4 text-white">Your Book Description</h2>
                    <form onSubmit={recommendBooks} className="space-y-5">
                        {/* Query Input */}
                        <textarea
                        value={queryText}
                        onChange={(e) => {
                            setQueryText(e.target.value);
                            setErrorMessage('');
                        }}
                        placeholder="e.g., A gripping tale about an interdimensional traveler who loses his memory and has to solve his own past to save the future."
                        rows="4"
                        className="w-full p-4 rounded-xl bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-inner"
                        />

                        {/* Filters (Category and Tone) */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label htmlFor="category" className="block text-sm font-medium text-gray-300 mb-1">
                            Filter by Category
                            </label>
                            <select
                            id="category"
                            value={categoryFilter}
                            onChange={(e) => setCategoryFilter(e.target.value)}
                            className="w-full p-3 rounded-xl bg-gray-700 border border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500 transition appearance-none"
                            >
                            {CATEGORY_OPTIONS.map(opt => (
                                <option key={opt} value={opt}>{opt}</option>
                            ))}
                            </select>
                        </div>
                        <div>
                            <label htmlFor="tone" className="block text-sm font-medium text-gray-300 mb-1">
                            Filter by Emotional Tone
                            </label>
                            <select
                            id="tone"
                            value={toneFilter}
                            onChange={(e) => setToneFilter(e.target.value)}
                            className="w-full p-3 rounded-xl bg-gray-700 border border-gray-600 text-white focus:ring-indigo-500 focus:border-indigo-500 transition appearance-none"
                            >
                            {TONE_OPTIONS.map(opt => (
                                <option key={opt} value={opt}>{opt}</option>
                            ))}
                            </select>
                        </div>
                        </div>

                        {/* Submit Button */}
                        <button
                        type="submit"
                        disabled={isLoading || !isAuthReady}
                        className="w-full py-3 px-6 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl shadow-lg shadow-indigo-500/30 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                        >
                        {isLoading ? (
                            <svg className="animate-spin h-5 w-5 text-white mr-3" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        ) : (
                            'Get Recommendations'
                        )}
                        </button>
                        
                        {errorMessage && (
                        <div className="p-3 bg-red-800/50 text-red-300 rounded-xl text-sm font-medium">
                            {errorMessage}
                        </div>
                        )}
                    </form>
                    </div>

                    {/* Recommendation Results */}
                    <div className="space-y-4">
                    <h2 className="text-2xl font-bold text-white border-b border-gray-700 pb-2">
                        Recommended Books
                    </h2>
                    {recommendations.length > 0 ? (
                        <div className="space-y-6">
                        {recommendations.map((book) => (
                            <div key={book.id} className="bg-gray-800 p-5 rounded-2xl shadow-lg border border-indigo-500/50 transition hover:border-indigo-500">
                            <h3 className="text-xl font-semibold text-indigo-400">{book.title}</h3>
                            <p className="text-sm text-gray-400 mb-2">
                                {book.author} | {book.category} | Tone: {book.tone}
                            </p>
                            <p className="text-gray-300 mt-3">{book.description}</p>
                            </div>
                        ))}
                        </div>
                    ) : !isLoading && queryText && !errorMessage && (
                        <div className="p-5 bg-gray-800/50 rounded-xl text-gray-400">
                            Enter a description and click "Get Recommendations" to start your search!
                        </div>
                    )}
                    </div>
                </div>

                {/* RIGHT COLUMN: Search History */}
                <div className="lg:col-span-1 h-[70vh] lg:h-auto">
                    {MemoizedHistory}
                </div>
                </main>
            </div>
            </div>
        );
        };

        // Render the application to the DOM using React 18's createRoot API
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);

    </script>
</body>
</html>

